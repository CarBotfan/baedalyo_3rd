<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.beadalyo.jhw.useraddr.UserAddrMapper">
    <insert id="postUserAddr" keyProperty="addrPk" useGeneratedKeys="true">
        INSERT INTO address (
        addr_user_pk,
        addr_name,
        addr1,
        addr2,
        addr_coor_x,
        addr_coor_y,
        addr_default
        )
        SELECT
        #{signedUserId},
        #{addrName},
        #{addr1},
        #{addr2},
        #{addrCoorX},
        #{addrCoorY},
        CASE WHEN
        (SELECT COUNT(*) FROM address WHERE addr_user_pk = #{signedUserId}) = 0
        THEN #{signedUserId} ELSE NULL END
    </insert>
    <select id="getUserAddrList">
        SELECT addr_pk AS addrPk, addr_name AS addrName, addr1, addr2
        , addr_coor_x AS addrCoorX
        , addr_coor_y AS addrCoorY
        FROM address
        WHERE addr_user_pk = #{signedUserPk}
        ORDER BY addr_default DESC, created_at DESC
    </select>
    <select id="getUserAddr">
        SELECT addr_pk AS addrPk, addr_name AS addrName, addr1, addr2
        , addr_coor_x AS addrCoorX
        , addr_coor_y AS addrCoorY
        FROM address
        WHERE addr_user_pk = #{signedUserPk}
        AND addr_pk = #{addrPk}
    </select>
    <select id="getMainUserAddr">
        SELECT addr_pk AS addrPk, addr_name AS addrName, addr1, addr2
        , addr_coor_x AS addrCoorX
        , addr_coor_y AS addrCoorY
        FROM address
        WHERE addr_user_pk = #{signedUserPk}
        AND addr_default = #{signedUserPk}
    </select>
    <update id="patchCurrentMainUserAddr">
        UPDATE address
        <set>
            <if test="signedUserPk != 0">
                addr_default = 0
            </if>
        </set>
        WHERE addr_user_pk = #{signedUserPk}
        AND addr_default = #{signedUserPk}
    </update>
    <update id="patchMainUserAddr">
        UPDATE address
        <set>
            <if test="signedUserPk != 0">
                addr_default = #{signedUserPk}
            </if>
        </set>
        WHERE addr_Pk = #{changeAddrPk}
    </update>
    <update id="updUserAddr">
        UPDATE address
        SET addr_name = #{addrName}
        , addr1 = #{addr1}
        , addr2 = #{addr2}
        , addr_coor_x = #{addrCoorX}
        , addr_coor_y = #{addrCoorY}
        WHERE addr_user_pk = #{signedUserPk}
        AND addr_Pk = #{addrPk}
    </update>
    <delete id="deleteUserAddr">
        DELETE FROM address
        WHERE addr_user_pk = #{signedUserPk}
        AND addr_pk = #{addrPk}
    </delete>
</mapper>
